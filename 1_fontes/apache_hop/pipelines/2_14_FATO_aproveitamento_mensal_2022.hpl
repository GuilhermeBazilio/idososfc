<?xml version="1.0" encoding="UTF-8"?>
<pipeline>
  <info>
    <name>2_14_FATO_aproveitamento_mensal_2022</name>
    <name_sync_with_filename>Y</name_sync_with_filename>
    <description/>
    <extended_description/>
    <pipeline_version/>
    <pipeline_type>Normal</pipeline_type>
    <parameters>
    </parameters>
    <capture_transform_performance>N</capture_transform_performance>
    <transform_performance_capturing_delay>1000</transform_performance_capturing_delay>
    <transform_performance_capturing_size_limit>100</transform_performance_capturing_size_limit>
    <created_user>-</created_user>
    <created_date>2022/12/05 21:11:06.285</created_date>
    <modified_user>-</modified_user>
    <modified_date>2022/12/05 21:11:06.285</modified_date>
  </info>
  <notepads>
  </notepads>
  <order>
  </order>
  <transform>
    <name>Insere dados FATO_aproveitamento_mensal_2022</name>
    <type>ExecSql</type>
    <description/>
    <distribute>Y</distribute>
    <custom_distribution/>
    <copies>1</copies>
    <partitioning>
      <method>none</method>
      <schema_name/>
    </partitioning>
    <arguments>
</arguments>
    <connection>db_bazilio_test</connection>
    <delete_field/>
    <execute_each_row>N</execute_each_row>
    <insert_field/>
    <quoteString>N</quoteString>
    <read_field/>
    <replace_variables>N</replace_variables>
    <set_params>N</set_params>
    <single_statement>N</single_statement>
    <sql>drop table IF EXISTS IDOSOS_STG.FATO_aproveitamento_mensal_2022;

with CADASTRO(	CADASTRO_id, 
				CADASTRO_atleta,
				PONTOS_ESPERADOS_JANEIRO,
				PONTOS_ESPERADOS_FEVEREIRO,
				PONTOS_ESPERADOS_MARCO,
				PONTOS_ESPERADOS_ABRIL,
				PONTOS_ESPERADOS_MAIO,
				PONTOS_ESPERADOS_JUNHO,
				PONTOS_ESPERADOS_JULHO,
				PONTOS_ESPERADOS_AGOSTO,
				PONTOS_ESPERADOS_SETEMBRO,
				PONTOS_ESPERADOS_OUTUBRO,
				PONTOS_ESPERADOS_NOVEMBRO,
				PONTOS_ESPERADOS_DEZEMBRO)
as
(
	SELECT ATLETA.ID,
		ATLETA.ATLETA,
		(SELECT IDOSOS_STG.f_qtd_partidas_mes(1,2022) * 3) as PONTOS_ESPERADOS_JANEIRO,
		(SELECT IDOSOS_STG.f_qtd_partidas_mes(2,2022) * 3) as PONTOS_ESPERADOS_FEVEREIRO,
		(SELECT IDOSOS_STG.f_qtd_partidas_mes(3,2022) * 3) as PONTOS_ESPERADOS_MARCO,
		(SELECT IDOSOS_STG.f_qtd_partidas_mes(4,2022) * 3) as PONTOS_ESPERADOS_ABRIL,
		(SELECT IDOSOS_STG.f_qtd_partidas_mes(5,2022) * 3) as PONTOS_ESPERADOS_MAIO,
		(SELECT IDOSOS_STG.f_qtd_partidas_mes(6,2022) * 3) as PONTOS_ESPERADOS_JUNHO,
		(SELECT IDOSOS_STG.f_qtd_partidas_mes(7,2022) * 3) as PONTOS_ESPERADOS_JULHO,
		(SELECT IDOSOS_STG.f_qtd_partidas_mes(8,2022) * 3) as PONTOS_ESPERADOS_AGOSTO,
		(SELECT IDOSOS_STG.f_qtd_partidas_mes(9,2022) * 3) as PONTOS_ESPERADOS_SETEMBRO,
		(SELECT IDOSOS_STG.f_qtd_partidas_mes(10,2022) * 3) as PONTOS_ESPERADOS_OUTUBRO,
		(SELECT IDOSOS_STG.f_qtd_partidas_mes(11,2022) * 3) as PONTOS_ESPERADOS_NOVEMBRO,
		(SELECT IDOSOS_STG.f_qtd_partidas_mes(12,2022) * 3) as PONTOS_ESPERADOS_DEZEMBRO
		/*
		(select QTDE *3 qtde_pontos_esperados from f_qtd_partidas_mes(1)) AS PONTOS_ESPERADOS_JANEIRO,
		(select QTDE *3 qtde_pontos_esperados from f_qtd_partidas_mes(2)) AS PONTOS_ESPERADOS_FEVEREIRO,
		(select QTDE *3 qtde_pontos_esperados from f_qtd_partidas_mes(3)) AS PONTOS_ESPERADOS_MARCO,
		(select QTDE *3 qtde_pontos_esperados from f_qtd_partidas_mes(4)) AS PONTOS_ESPERADOS_ABRIL,
		(select QTDE *3 qtde_pontos_esperados from f_qtd_partidas_mes(5)) AS PONTOS_ESPERADOS_MAIO,
		(select QTDE *3 qtde_pontos_esperados from f_qtd_partidas_mes(6)) AS PONTOS_ESPERADOS_JUNHO,
		(select QTDE *3 qtde_pontos_esperados from f_qtd_partidas_mes(7)) AS PONTOS_ESPERADOS_JULHO,
		(select QTDE *3 qtde_pontos_esperados from f_qtd_partidas_mes(8)) AS PONTOS_ESPERADOS_AGOSTO,
		(select QTDE *3 qtde_pontos_esperados from f_qtd_partidas_mes(9)) AS PONTOS_ESPERADOS_SETEMBRO,
		(select QTDE *3 qtde_pontos_esperados from f_qtd_partidas_mes(10)) AS PONTOS_ESPERADOS_OUTUBRO,
		(select QTDE *3 qtde_pontos_esperados from f_qtd_partidas_mes(11)) AS PONTOS_ESPERADOS_NOVEMBRO,
		(select QTDE *3 qtde_pontos_esperados from f_qtd_partidas_mes(12)) AS PONTOS_ESPERADOS_DEZEMBRO
		*/

	FROM IDOSOS_STG.dim_atletas ATLETA
),
PONTOS (ID,ATLETA, JANEIRO,FEVEREIRO, MARCO, ABRIL, MAIO,JUNHO,JULHO,AGOSTO,SETEMBRO,OUTUBRO,NOVEMBRO,DEZEMBRO)
as
(
	select ID,ATLETA, JANEIRO,FEVEREIRO, MARCO, ABRIL, MAIO,JUNHO,JULHO,AGOSTO,SETEMBRO,OUTUBRO,NOVEMBRO,DEZEMBRO from IDOSOS_STG.FATO_pontos_2022
)

SELECT	CADASTRO_id AS ID,
		CADASTRO_atleta AS ATLETA,
		sum(
			(CAST(JANEIRO AS decimal)/ 
				(CAST(
						CASE
							WHEN PONTOS_ESPERADOS_JANEIRO &lt;=0 THEN
								1
							ELSE	
								PONTOS_ESPERADOS_JANEIRO
						END  AS DECIMAL )
										 )
										  )
										   *100) over (partition by cadastro_id) JANEIRO,
		sum(
			(CAST(FEVEREIRO AS decimal)/ 
				(CAST(
						CASE
							WHEN PONTOS_ESPERADOS_FEVEREIRO &lt;=0 THEN
								1
							ELSE	
								PONTOS_ESPERADOS_FEVEREIRO
						END  AS DECIMAL )
										 )
										  )
										   *100) over (partition by cadastro_id) FEVEREIRO,
		sum(
			(CAST(MARCO AS decimal)/ 
				(CAST(
						CASE
							WHEN PONTOS_ESPERADOS_MARCO &lt;=0 THEN
								1
							ELSE	
								PONTOS_ESPERADOS_MARCO
						END  AS DECIMAL )
										 )
										  )
										   *100) over (partition by cadastro_id) MARCO,
		sum(
			(CAST(ABRIL AS decimal)/ 
				(CAST(
						CASE
							WHEN PONTOS_ESPERADOS_ABRIL &lt;=0 THEN
								1
							ELSE	
								PONTOS_ESPERADOS_ABRIL
						END  AS DECIMAL )
										 )
										  )
										   *100) over (partition by cadastro_id) ABRIL,
		sum(
			(CAST(MAIO AS decimal)/ 
				(CAST(
						CASE
							WHEN PONTOS_ESPERADOS_MAIO &lt;=0 THEN
								1
							ELSE	
								PONTOS_ESPERADOS_MAIO
						END  AS DECIMAL )
										 )
										  )
										   *100) over (partition by cadastro_id) MAIO,
		sum(
			(CAST(JUNHO AS decimal)/ 
				(CAST(
						CASE
							WHEN PONTOS_ESPERADOS_JUNHO &lt;=0 THEN
								1
							ELSE	
								PONTOS_ESPERADOS_JUNHO
						END  AS DECIMAL )
										 )
										  )
										   *100) over (partition by cadastro_id) JUNHO,
		sum(
			(CAST(JULHO AS decimal)/ 
				(CAST(
						CASE
							WHEN PONTOS_ESPERADOS_JULHO &lt;=0 THEN
								1
							ELSE	
								PONTOS_ESPERADOS_JULHO
						END  AS DECIMAL )
										 )
										  )
										   *100) over (partition by cadastro_id) JULHO,
		sum(
			(CAST(AGOSTO AS decimal)/ 
				(CAST(
						CASE
							WHEN PONTOS_ESPERADOS_AGOSTO &lt;=0 THEN
								1
							ELSE	
								PONTOS_ESPERADOS_AGOSTO
						END  AS DECIMAL )
										 )
										  )
										   *100) over (partition by cadastro_id) AGOSTO,
		sum(
			(CAST(SETEMBRO AS decimal)/ 
				(CAST(
						CASE
							WHEN PONTOS_ESPERADOS_SETEMBRO &lt;=0 THEN
								1
							ELSE	
								PONTOS_ESPERADOS_SETEMBRO
						END  AS DECIMAL )
										 )
										  )
										   *100) over (partition by cadastro_id) SETEMBRO,
		sum(
			(CAST(OUTUBRO AS decimal)/ 
				(CAST(
						CASE
							WHEN PONTOS_ESPERADOS_OUTUBRO &lt;=0 THEN
								1
							ELSE	
								PONTOS_ESPERADOS_OUTUBRO
						END  AS DECIMAL )
										 )
										  )
										   *100) over (partition by cadastro_id) OUTUBRO,
		sum(
			(CAST(NOVEMBRO AS decimal)/ 
				(CAST(
						CASE
							WHEN PONTOS_ESPERADOS_NOVEMBRO &lt;=0 THEN
								1
							ELSE	
								PONTOS_ESPERADOS_NOVEMBRO
						END  AS DECIMAL )
										 )
										  )
										   *100) over (partition by cadastro_id) NOVEMBRO,
		sum(
			(CAST(DEZEMBRO AS decimal)/ 
				(CAST(
						CASE
							WHEN PONTOS_ESPERADOS_DEZEMBRO &lt;=0 THEN
								1
							ELSE	
								PONTOS_ESPERADOS_DEZEMBRO
						END  AS DECIMAL )
										 )
										  )
										   *100) over (partition by cadastro_id) DEZEMBRO,
	   GETDATE() AS DATA_CARGA
INTO
			IDOSOS_STG.FATO_aproveitamento_mensal_2022
FROM CADASTRO
LEFT JOIN PONTOS 
	ON  CADASTRO_id = PONTOS.ID


CREATE INDEX  idx_fato_aproveitamento_mensal_2022 ON IDOSOS_STG.FATO_aproveitamento_mensal_2022 (id);

</sql>
    <update_field/>
    <attributes/>
    <GUI>
      <xloc>400</xloc>
      <yloc>160</yloc>
    </GUI>
  </transform>
  <transform_error_handling>
  </transform_error_handling>
  <attributes/>
</pipeline>
